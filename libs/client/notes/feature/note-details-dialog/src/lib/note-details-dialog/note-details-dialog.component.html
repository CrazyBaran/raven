<ng-template #windowTitleBarRef let-win>
  <span class="k-window-title">Note</span>
  <button kendoWindowMinimizeAction [window]="win"></button>
  <button kendoWindowRestoreAction [window]="win"></button>
  <button kendoWindowMaximizeAction [window]="win"></button>
  <button
    (click)="onClose($event)"
    [svgIcon]="icon"
    fillMode="flat"
    kendoButton
  ></button>
</ng-template>

<div *ngIf="vm().isLoading; else noteDetailsView" class="flex py-20">
  <ui-loader />
</div>
<ng-container #container />

<ng-template #noteDetailsView>
  <div *ngIf="noteDetails() as noteDetails" class="flex h-full flex-col gap-6">
    <ng-container *ngIf="!editMode; else editView">
      <div class="flex flex-row justify-between">
        <div class="flex flex-row items-center gap-5">
          <div
            *ngIf="noteDetails?.templateName"
            class="text-xxs bg-primary-500 flex h-6 w-fit items-center rounded px-[0.375rem] font-normal"
          >
            {{ noteDetails?.templateName }}
          </div>
          <span class="font-bold">
            {{ noteDetails?.name }}
          </span>
        </div>

        <div>
          <i class="fa-solid fa-circle-user mr-1"></i>
          {{ noteDetails?.createdBy?.name }}
        </div>
      </div>

      <div *ngIf="!!noteDetails.tags.length" class="flex flex-col gap-4">
        <ul class="flex flex-row flex-wrap gap-[0_0.75rem]">
          @for (
            tag of noteDetails.tags | tagFilter: ['people'] : false;
            track tag.id
          ) {
            <ui-tag [label]="tag.name" [style]="tag.type | tagTypeColor" />
          }
        </ul>

        <ul class="flex flex-row flex-wrap gap-[0_0.75rem]">
          @for (tag of noteDetails.tags | tagFilter: ['people']; track tag.id) {
            <ui-tag uiUserTag [label]="tag.name" />
          }
        </ul>
      </div>

      <div
        class="border-grey-200 grid min-h-0 grow grid-cols-[auto_1fr] gap-6 overflow-hidden border-t border-solid pt-4"
      >
        <div class="min-w-[160px]">
          <p class="mb-4 overflow-auto text-xs">Quick scroll</p>

          <ul>
            <li *ngFor="let field of vm().fields">
              <button
                (click)="handleScrollToField(field.id)"
                fillMode="flat"
                kendoButton
                themeColor="secondary"
              >
                {{ field.name }}
              </button>
            </li>
          </ul>
        </div>

        <div class="overflow-auto">
          <kendo-expansionpanel
            *ngFor="let note of vm().noteFields"
            [expanded]="true"
            [id]="note.id"
            [title]="note.name"
          >
            <div *ngIf="!note.value; else noteView" class="text-sm italic">
              Note is empty
            </div>
            <ng-template #noteView>
              <div
                *rxLet="note.value | populateAzureImages; let value"
                [innerHTML]="value | safeHtml"
                class="ProseMirror"
              ></div>
            </ng-template>
          </kendo-expansionpanel>
        </div>
      </div>

      <div class="flex flex-row items-center justify-between gap-6">
        <kendo-button
          [uiClipboard]="
            {
              currentUrl: true
            } | toUrl
          "
          iconClass="fa-solid fa-link"
          size="medium"
          >Copy Link</kendo-button
        >

        <div class="flex flex-row gap-3" kendoTooltip>
          <div class="flex items-center justify-center gap-3 text-xs">
            <span>
              Created:{{ noteDetails?.createdAt | date: 'dd/MM/yyyy hh:mm a' }}
            </span>
            <span>
              Updated:{{
                noteDetails?.updatedAt
                  ? (noteDetails?.updatedAt | date: 'dd/MM/yyyy hh:mm a')
                  : '-'
              }}
            </span>
          </div>

          <kendo-button
            (click)="handleDeleteNote(noteDetails?.id)"
            fillMode="outline"
            iconClass="fa-regular fa-trash-can"
            size="large"
            themeColor="primary"
            >Delete</kendo-button
          >
          <div
            [title]="
              !vm().canEditNote
                ? 'You do not have access to edit this note'
                : ''
            "
          >
            <kendo-button
              [disabled]="!vm().canEditNote"
              [class.!opacity-40]="!vm().canEditNote"
              (click)="editMode = true"
              fillMode="outline"
              iconClass="fa-regular fa-pen"
              size="large"
              themeColor="primary"
              >Edit / Update</kendo-button
            >
          </div>

          <kendo-button
            (click)="handleCloseWindow()"
            size="large"
            themeColor="primary"
            >Close</kendo-button
          >
        </div>
      </div>
    </ng-container>
  </div>
</ng-template>

<ng-template #editView>
  <app-notepad-form
    [formControl]="notepadForm"
    class="block min-h-0 grow basis-0"
  ></app-notepad-form>
  <div class="flex gap-3">
    <kendo-button
      (click)="closeEdit()"
      class="ml-auto"
      fillMode="outline"
      iconClass="fa-regular fa-pen"
      size="large"
      themeColor="primary"
      >Cancel</kendo-button
    >
    <kendo-button
      (click)="updateNote()"
      [disabled]="isUpdating() || !notepadForm.valid"
      size="large"
      themeColor="primary"
      >Update Note</kendo-button
    >
  </div>
</ng-template>
