<div class="absolute left-0 top-0 h-screen w-screen overflow-hidden">
  <kendo-window
    (close)="handleCloseWindow()"
    title="Note"
    themeColor="primary"
    [width]="860"
    [height]="800"
    class="max-h-full"
  >
    <div class="flex py-20" *ngIf="isLoading$ | async; else noteDetailsView">
      <ui-loader />
    </div>
  </kendo-window>
</div>

<ng-template #noteDetailsView>
  <div class="flex h-full flex-col gap-6" *ngIf="noteDetails">
    <ng-container *ngIf="!editMode; else editView">
      <div class="flex flex-row justify-between">
        <div class="flex flex-row items-center gap-5">
          <div
            class="text-xxs bg-primary-500 flex h-6 w-fit items-center rounded px-[0.375rem] font-normal"
            *ngIf="noteDetails.templateName"
          >
            {{ noteDetails.templateName }}
          </div>
          <span class="font-bold">
            {{ noteDetails.name }}
          </span>
        </div>

        <div>
          <i class="fa-solid fa-circle-user mr-1"></i>
          {{ noteDetails.createdBy.name }}
        </div>
      </div>

      <div class="flex flex-col gap-4" *ngIf="!!noteDetails.tags.length">
        <ul class="flex flex-row flex-wrap gap-[0_0.75rem]">
          <li
            *ngFor="let tag of noteDetails.tags | tagFilter: ['people'] : false"
            class="text-sm"
            [ngClass]="{
              'text-error':
                tag.type === 'company' || tag.type === 'opportunity',
              'text-success': tag.type === 'industry',
              'text-warning': tag.type === 'investor',
              'text-primary-900': tag.type === 'businessModel'
            }"
          >
            <i class="fa-regular fa-tag mr-1"></i>
            {{ tag.name }}
          </li>
        </ul>

        <ul class="flex flex-row flex-wrap gap-[0_0.75rem]">
          <li
            *ngFor="let tag of noteDetails.tags | tagFilter: ['people']"
            class="text-sm"
          >
            <i class="fa-regular fa-circle-user mr-1"></i>
            {{ tag.name }}
          </li>
        </ul>
      </div>

      <div
        class="border-grey-200 grid min-h-0 grow grid-cols-[auto_1fr] gap-6 overflow-hidden border-t border-solid pt-4"
      >
        <div class="min-w-[160px]">
          <p class="mb-4 overflow-auto text-xs">Quick scroll</p>

          <ul>
            <li *ngFor="let field of fields">
              <button
                kendoButton
                fillMode="flat"
                themeColor="secondary"
                (click)="handleScrollToField(field.id)"
              >
                {{ field.name }}
              </button>
            </li>
          </ul>
        </div>

        <div class="overflow-auto">
          <kendo-expansionpanel
            [title]="note.name"
            *ngFor="let note of noteFields"
            [id]="note.id"
            [expanded]="true"
          >
            <div *ngIf="!note.value; else noteView" class="text-sm italic">
              Note is empty
            </div>
            <ng-template #noteView>
              <div
                class="ProseMirror"
                [innerHTML]="note.value | safeHtml"
              ></div>
            </ng-template>
          </kendo-expansionpanel>
        </div>
      </div>

      <div class="flex flex-row items-center justify-between gap-6">
        <kendo-button
          iconClass="fa-solid fa-link"
          size="medium"
          (click)="handleCopyLink()"
          >Copy Link</kendo-button
        >

        <div class="flex flex-row gap-3">
          <div class="flex items-center justify-center gap-3 text-xs">
            <span>
              Created:{{ noteDetails.createdAt | date: 'dd/MM/yyyy' }}
            </span>
            <span>
              Updated:{{
                noteDetails.updatedAt
                  ? (noteDetails.updatedAt | date: 'dd/MM/yyyy')
                  : '-'
              }}
            </span>
          </div>

          <kendo-button
            themeColor="primary"
            iconClass="fa-regular fa-trash-can"
            fillMode="outline"
            size="large"
            (click)="handleDeleteNote(noteDetails.id)"
            >Delete</kendo-button
          >
          <kendo-button
            themeColor="primary"
            fillMode="outline"
            iconClass="fa-regular fa-pen"
            size="large"
            (click)="editMode = true"
            >Edit / Update</kendo-button
          >
          <kendo-button
            themeColor="primary"
            size="large"
            (click)="handleCloseWindow()"
            >Close</kendo-button
          >
        </div>
      </div>
    </ng-container>
  </div>
</ng-template>

<ng-template #editView>
  <app-notepad-form
    class="block min-h-0 grow basis-0"
    [formControl]="notepadForm"
  ></app-notepad-form>
  <div class="flex gap-3">
    <kendo-button
      themeColor="primary"
      fillMode="outline"
      iconClass="fa-regular fa-pen"
      size="large"
      class="ml-auto"
      (click)="editMode = false"
      >Cancel</kendo-button
    >
    <kendo-button
      themeColor="primary"
      size="large"
      (click)="updateNote()"
      [disabled]="isUpdating() || !notepadForm.valid"
      >Update Note</kendo-button
    >
  </div>
</ng-template>

<ng-container #container></ng-container>
