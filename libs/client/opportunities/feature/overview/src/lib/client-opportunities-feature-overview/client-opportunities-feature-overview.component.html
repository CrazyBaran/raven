<kendo-tilelayout
  [columns]="12"
  [draggable]="false"
  [gap]="24"
  class="h-full grid-rows-[auto_1fr] !p-0"
  rowHeight="auto"
>
  <!--  DETAILS   -->
  <kendo-tilelayout-item [colSpan]="4" [rowSpan]="2" class="h-full">
    <kendo-tilelayout-item-header>
      <div class="flex items-center justify-between gap-2">
        <h5 class="k-card-title">Details</h5>
        <kendo-button
          [queryParams]="{ 'opportunity-edit': vm().id }"
          [routerLink]="['./']"
          iconClass="fa-sharp fa-solid fa-pen"
          queryParamsHandling="merge"
          size="small"
          >Edit</kendo-button
        >
      </div>
    </kendo-tilelayout-item-header>
    <kendo-tilelayout-item-body>
      <div
        class="bg-grey-100 flex max-h-full flex-col gap-3 overflow-auto bg-opacity-50 px-6 py-5"
      >
        <ng-container *ngIf="vm().isLoadingDetails; else details">
          <div *ngFor="let i of 7 | times" class="px-2 py-3">
            <kendo-skeleton [height]="20" class="mb-1" width="170px" />
            <kendo-skeleton [height]="10" width="125px" />
          </div>
        </ng-container>
        <ng-template #details>
          <div
            *rxFor="let detail of vm().details; trackBy: 'label'"
            [@fadeIn]
            class="px-2 py-3"
          >
            <h1 class="text-lg">{{ detail.label }}</h1>
            <p class="!m-0 text-sm">{{ detail.subLabel }}</p>
          </div>
        </ng-template>
      </div>
    </kendo-tilelayout-item-body>
  </kendo-tilelayout-item>

  <!--  DEAL TEAM   -->
  <kendo-tilelayout-item [colSpan]="9" class="h-[200px]">
    <kendo-tilelayout-item-header>
      <div class="flex items-center justify-between gap-2">
        <h5 class="k-card-title">Deal Team</h5>
        <kendo-button
          *ngIf="vm().canEditTeam"
          (click)="openTeamEdit()"
          iconClass="fa-sharp fa-solid fa-pen"
          size="small"
          >Edit</kendo-button
        >
      </div>
    </kendo-tilelayout-item-header>
    <kendo-tilelayout-item-body>
      <kendo-grid [data]="vm().team" class="grid-borderless h-full">
        <kendo-grid-column
          [width]="1"
          field="dealLead"
          headerClass="!font-bold"
          title="Deal Lead"
        >
          <ng-template kendoGridCellTemplate let-dataItem>
            <ng-container *ngIf="!vm().isLoadingDetails; else tagSkeleton">
              <ui-tag
                *rxFor="let name of dataItem.dealLeads"
                [label]="name"
                uiUserTag
              />
            </ng-container>
          </ng-template>
        </kendo-grid-column>
        <kendo-grid-column
          [width]="3"
          field="dealTeam"
          headerClass="!font-bold"
          title="Deal Team"
        >
          <ng-template kendoGridCellTemplate let-dataItem>
            <div
              *ngIf="!vm().isLoadingDetails; else tagSkeleton"
              class="flex flex-wrap gap-x-6 gap-y-1"
            >
              <ui-tag
                *rxFor="let user of dataItem.dealTeam; trackBy: 'name'"
                [label]="user.name"
                uiUserTag
              ></ui-tag>
            </div>
          </ng-template>
        </kendo-grid-column>
      </kendo-grid>
    </kendo-tilelayout-item-body>
  </kendo-tilelayout-item>

  <!--  MISSING DD DETAILS-->
  <kendo-tilelayout-item [colSpan]="9">
    <kendo-tilelayout-item-header>
      <div class="flex items-center justify-between gap-2">
        <h5 class="k-card-title">Missing DD Details</h5>
      </div>
    </kendo-tilelayout-item-header>
    <kendo-tilelayout-item-body>
      <kendo-grid
        #paging="uiKendoDynamicPaging"
        [kendoGridBinding]="vm().missingDetails"
        [loading]="vm().isLoading"
        [pageSize]="paging.size()"
        [pageable]="true"
        [uiKendoDynamicPaging]="36"
        class="grid-borderless h-full"
      >
        <ng-template kendoGridLoadingTemplate>
          <ui-loader [disableInfo]="true" class="bg-white bg-opacity-60" />
        </ng-template>
        <kendo-grid-column [width]="40">
          <ng-template kendoGridCellTemplate let-dataItem>
            <i class="fa-light fa-circle-exclamation text-warning"></i>
          </ng-template>
        </kendo-grid-column>

        <kendo-grid-column field="tab" headerClass="!font-bold" title="Tab">
        </kendo-grid-column>

        <kendo-grid-column field="field" headerClass="!font-bold" title="Field">
        </kendo-grid-column>

        <kendo-grid-column
          field="action"
          headerClass="!font-bold"
          title="Action"
        >
        </kendo-grid-column>
      </kendo-grid>
    </kendo-tilelayout-item-body>
  </kendo-tilelayout-item>
</kendo-tilelayout>

<ng-template #tagSkeleton>
  <div class="flex gap-1">
    <kendo-skeleton shape="circle" width="20px"></kendo-skeleton>
    <kendo-skeleton width="80px"></kendo-skeleton>
  </div>
</ng-template>

<kendo-dialog
  *ngIf="showEditTeam()"
  (close)="showEditTeam.set(false)"
  [width]="480"
  title="Deal Team Admin"
>
  <!--  themeColor="primary"-->
  <div [formGroup]="teamFormGroup" class="flex flex-col gap-4 p-10">
    <kendo-formfield>
      <kendo-label text="Add People to Deal Team"></kendo-label>
      <kendo-multiselect
        [autoClose]="false"
        [checkboxes]="true"
        [data]="vm().users"
        [itemDisabled]="(peopleItemDisabled$ | async)!"
        [textField]="'name'"
        [valueField]="'id'"
        class="multiselect-without-remove-all w-full overflow-hidden"
        formControlName="people"
      />
    </kendo-formfield>

    <div
      *ngFor="let role of teamFormGroup.controls.roles!.controls ?? []"
      class="flex justify-between"
    >
      <ui-tag [label]="role.controls.user.value?.name" uiUserTag />
      <kendo-dropdownlist
        [data]="rolesData"
        class="!w-[126px] overflow-hidden"
        [formControl]="role.controls.role"
        [disabled]="adminCount() < 2 && role.controls.role.value === 'admin'"
        fillMode="outline"
      />
    </div>
  </div>

  <kendo-dialog-actions>
    <kendo-button (click)="showEditTeam.set(false)"> Cancel </kendo-button>
    <kendo-button
      (click)="updateTeam()"
      [disabled]="vm().updateTeamLoading! || !adminCount()"
      themeColor="primary"
    >
      <kendo-loader
        *ngIf="vm().updateTeamLoading"
        class="!text-secondary-100 mr-1"
        size="small"
      />
      Confirm Deal Team
    </kendo-button>
  </kendo-dialog-actions>
</kendo-dialog>
