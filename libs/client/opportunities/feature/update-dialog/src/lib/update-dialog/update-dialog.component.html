<ng-container *rxLet="vm$; let vm">
  <kendo-dialog-titlebar (close)="onDialogClose()">
    <span class="k-window-title">Edit Details</span>
  </kendo-dialog-titlebar>

  <!--  TODO: Extract and reuse form component for create and update dialog-->
  <form
    *ngIf="vm.opportunityDetails; else loader"
    [formGroup]="opportunityForm"
    class="flex min-h-0 flex-1 flex-col gap-4 overflow-auto p-10"
  >
    <kendo-formfield>
      <kendo-label text="Company Name" />
      <kendo-combobox
        [data]="vm.companyCombobox.data"
        [loading]="vm.companyCombobox.isLoading"
        [textField]="vm.companyCombobox.textField"
        [valueField]="vm.companyCombobox.valueField"
        [valuePrimitive]="true"
        [virtual]="true"
        formControlName="organisationId"
        placeholder="Search Company Names"
      />
      <kendo-formerror
        *ngFor="
          let error of opportunityForm.controls.organisationId.errors ?? []
            | keyvalue
        "
        class="text-danger"
      >
        {{ error.key | errorMessage: error.value }}
      </kendo-formerror>
    </kendo-formfield>

    <kendo-formfield>
      <kendo-label text="Funding Round" />
      <kendo-dropdownlist
        [data]="vm.opportunityDropdown.data"
        [defaultItem]="defaultFundingRound"
        [loading]="vm.opportunityDropdown.isLoading"
        [textField]="vm.opportunityDropdown.textField"
        [valueField]="vm.opportunityDropdown.valueField"
        [valuePrimitive]="true"
        [virtual]="true"
        formControlName="opportunityTagId"
      />
      <kendo-formerror
        *ngFor="
          let error of opportunityForm.controls.opportunityTagId.errors ?? []
            | keyvalue
        "
        class="text-danger"
      >
        {{ error.key | errorMessage: error.value }}
      </kendo-formerror>
    </kendo-formfield>
    <kendo-formfield>
      <kendo-label text="Round Size" />
      <kendo-textbox formControlName="roundSize" placeholder="eg. $50m" />
    </kendo-formfield>
    <kendo-formfield>
      <kendo-label text="Valuation" />
      <kendo-textbox formControlName="valuation" placeholder="eg. $1bn" />
    </kendo-formfield>
    <kendo-formfield>
      <kendo-label text="Proposed Investment" />
      <kendo-textbox
        formControlName="proposedInvestment"
        placeholder="eg. $20m"
      />
    </kendo-formfield>
    <kendo-formfield orientation="horizontal">
      <kendo-label text="Positioning" />
      <ul class="k-radio-list k-list-horizontal">
        <li class="k-radio-item">
          <input
            #lead
            formControlName="positioning"
            kendoRadioButton
            type="radio"
            value="lead"
          />
          <kendo-label [for]="lead" text="Lead"></kendo-label>
        </li>

        <li class="k-radio-item">
          <input
            #follower
            formControlName="positioning"
            kendoRadioButton
            type="radio"
            value="follower"
          />
          <kendo-label [for]="follower" text="Follower"></kendo-label>
        </li>
      </ul>
    </kendo-formfield>
    <kendo-formfield>
      <kendo-label text="Timing" />
      <kendo-textbox formControlName="timing" placeholder="eg. Q2, 2023" />
    </kendo-formfield>
    <kendo-formfield>
      <kendo-label text="Under NDA?" />
      <kendo-dropdownlist
        [data]="ndaDropdown.data"
        [defaultItem]="ndaDropdown.default"
        [valuePrimitive]="true"
        formControlName="underNda"
        textField="name"
        valueField="id"
      />
    </kendo-formfield>
    <kendo-formfield>
      <kendo-label text="NDA Termination Date" />
      <kendo-dateinput
        formControlName="ndaTerminationDate"
        format="MM/dd/yyyy"
      ></kendo-dateinput>
    </kendo-formfield>
  </form>

  <kendo-dialog-actions>
    <kendo-button (click)="onDialogClose()" class="w-40">Cancel</kendo-button>
    <kendo-button
      (click)="onCreate()"
      [disabled]="!opportunityForm.valid || vm.isCreating"
      themeColor="primary"
    >
      <kendo-loader
        *ngIf="vm.isCreating"
        class="!text-secondary-100 mr-1"
        size="small"
      >
      </kendo-loader>
      Save
    </kendo-button>
  </kendo-dialog-actions>
</ng-container>

<ng-template #loader>
  <ui-loader class="flex-1" />
</ng-template>
