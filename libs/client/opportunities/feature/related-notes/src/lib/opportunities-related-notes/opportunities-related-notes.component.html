<div class="flex h-full gap-3">
  <div
    *ngIf="vm().fields?.length || vm().isLoading"
    class="custom-scroll-on-hover -mr-1.5 h-full flex-1 overflow-auto pr-1.5"
  >
    <kendo-tilelayout
      [columns]="12"
      [draggable]="false"
      [gap]="12"
      class="!p-0"
      rowHeight="minmax(300px, auto)"
    >
      <ng-container [formGroup]="formGroup">
        <ng-container *ngIf="vm().isLoading; else fields">
          <kendo-tilelayout-item
            *rxFor="let i of 2 | times"
            [colSpan]="12"
            [col]="1"
          >
            <kendo-tilelayout-item-header>
              <kendo-skeleton width="60%"></kendo-skeleton>
            </kendo-tilelayout-item-header>
            <kendo-tilelayout-item-body>
              <div class="flex flex-col gap-2">
                <kendo-skeleton width="60%"></kendo-skeleton>
                <kendo-skeleton width="35%"></kendo-skeleton>
                <kendo-skeleton width="70%"></kendo-skeleton>
                <kendo-skeleton width="35%"></kendo-skeleton>
                <kendo-skeleton width="70%"></kendo-skeleton>
              </div>
            </kendo-tilelayout-item-body>
          </kendo-tilelayout-item>
        </ng-container>
        <ng-template #fields>
          @if (vm().heatmapFields.length ){
          <kendo-tilelayout-item [@fadeIn] [colSpan]="12" [col]="1">
            <kendo-tilelayout-item-header>
              <div class="flex items-center justify-between gap-2">
                <h5 class="k-card-title">Financial KPIs</h5>
                <kendo-button
                  iconClass="fa-regular fa-pen"
                  [queryParams]="{ 'edit-financial-kpi': true }"
                  [routerLink]="['./']"
                  queryParamsHandling="merge"
                  >Edit</kendo-button
                >
              </div>
            </kendo-tilelayout-item-header>
            <kendo-tilelayout-item-body>
              <div class="flex flex-col gap-3">
                @for(fieldGroup of vm().heatmapFields; track fieldGroup.uniqId){
                <div>
                  <div
                    class="bg-chart-tooltip-bg border-chart-border mb-0.5 border px-3 py-2"
                  >
                    {{ fieldGroup.title }}
                  </div>
                  <div class="financial-grid grid gap-0.5">
                    @for(field of $any(fieldGroup).noteFields; track
                    field.uniqId){
                    <div
                      [ngStyle]="{
                        'background-color':
                          field.heat | heatColor: 'background',
                        color: field.heat | heatColor: 'font'
                      }"
                      class="bg-success flex min-h-[60px] flex-col justify-between px-2 py-1 text-white"
                    >
                      <div class="text-sm">{{ field.title }}</div>

                      <div class="text-end text-sm">
                        @if (field.value){
                        {{ field.value || '' }} {{ field.unit }}
                        }
                      </div>
                    </div>
                    }
                  </div>
                </div>

                }
              </div>
            </kendo-tilelayout-item-body>
          </kendo-tilelayout-item>
          }

          <kendo-tilelayout-item
            *rxFor="
              let field of fields$;
              let i = index;
              trackBy: 'formControlName'
            "
            [order]="i"
            [@fadeIn]
            [colSpan]="12"
            [col]="1"
          >
            <kendo-tilelayout-item-header>
              <div class="flex items-center justify-between gap-2">
                <h5 class="k-card-title">{{ field.title }}</h5>
                <ng-container
                  *ngIf="state().updatingField === field.formControlName"
                >
                  @switch (state().state) { @case ('validate') {

                  <div class="flex items-center gap-2" [@fadeIn]>
                    <kendo-loader
                      size="small"
                      type="infinite-spinner"
                      themeColor="primary"
                    />
                    Saving...
                  </div>

                  } @case ('updated') {
                  <div class="flex items-center gap-2" [@fadeIn]>
                    <i class="fa-solid fa-check text-primary-400"></i>
                    Saved
                  </div>
                  } @default { }}
                </ng-container>
              </div>
            </kendo-tilelayout-item-header>
            <kendo-tilelayout-item-body>
              <app-rich-text
                [disabled]="state().state === 'validate'"
                (valueChange)="onValueChange(field.formControlName)"
                [borderless]="true"
                [formControlName]="field.formControlName"
                [grow]="true"
                [proseSettings]="{ proseMirrorSettings: proseMirrorSettings }"
                class="h-full"
                [readonly]="!vm().canEditFields"
                placeholder="Click to write content here..."
              >
              </app-rich-text>
            </kendo-tilelayout-item-body>
          </kendo-tilelayout-item>
        </ng-template>
      </ng-container>
    </kendo-tilelayout>
  </div>

  <kendo-tilelayout
    [columns]="12"
    [draggable]="false"
    [gap]="12"
    class="h-full flex-1 !p-0"
    rowHeight="100%"
  >
    <kendo-tilelayout-item [colSpan]="12">
      <kendo-tilelayout-item-header>
        <kendo-skeleton
          *ngIf="vm().isLoading; else relatedNotesTitle"
          width="30%"
        ></kendo-skeleton>
        <ng-template #relatedNotesTitle>
          <p>Related Notes</p>
        </ng-template>
      </kendo-tilelayout-item-header>
      <kendo-tilelayout-item-body>
        <ng-container
          *ngIf="vm().isLoading"
          [ngTemplateOutlet]="relatedNoteSkeleton"
        />

        <ng-container
          *ngIf="!vm().notes?.length && !vm().isLoading"
          [ngTemplateOutlet]="relatedNote"
        />

        <app-related-notes-table
          *ngIf="vm().notes?.length && !vm().isLoading"
          [notes]="vm().notes"
        />
        <!--      NOTE    -->
      </kendo-tilelayout-item-body>
    </kendo-tilelayout-item>
  </kendo-tilelayout>
</div>

<ng-template #relatedNote>
  <div
    *rxLet="vm().visibleNoteWithFields; let note"
    class="flex h-full flex-col"
  >
    <ng-container *ngIf="note; else noNotesMessage">
      <header>
        <div class="flex flex-col">
          <div class="flex items-center">
            <!--        NOTE TYPE        -->
            <app-note-type-badge
              [type]="note.templateName"
            ></app-note-type-badge>

            <!--        CREATE INFO       -->
            <div class="grow px-3 py-2">
              <div class="flex flex-col gap-1">
                <span>
                  <i class="fa-solid fa-circle-user mr-1"></i>
                  {{ note.createdBy.name || '' }}
                </span>

                <span *ngIf="$any(note).updatedAt" class="text-xs">
                  Updated:
                  {{ $any(note).updatedAt || '' | date: 'dd/MM/yyyy hh:mm a' }}
                </span>
              </div>
            </div>

            <!--        ACTION ICON       -->
            <div class="p-3">
              <kendo-button
                [queryParams]="{ 'note-details': note.id }"
                [routerLink]="['./']"
                iconClass="fa-solid fa-eye"
                queryParamsHandling="merge"
                themeColor="primary"
              >
              </kendo-button>
            </div>
          </div>
          <div class="px-3 pb-6 pt-3">
            <p class="font-bold">{{ note.name }}</p>
          </div>
        </div>
      </header>
      <article
        class="border-component-border grow basis-0 overflow-auto border-b border-t"
      >
        <div class="h-full">
          <div *rxFor="let field of note.fields" class="flex flex-col gap-3">
            <div class="p-3">
              <div class="mb-2 text-[10px] uppercase">
                {{ field.name }}
              </div>
              <div
                *rxLet="field.value | populateAzureImages; let value"
                [innerHTML]="value | safeHtml"
                class="ProseMirror"
              ></div>
            </div>
          </div>
        </div>
      </article>
    </ng-container>

    <footer>
      <div class="flex items-center justify-between gap-2 p-3">
        <kendo-button
          [disabled]="vm().disabledPrev"
          [queryParams]="vm().prevQueryParam"
          [routerLink]="[]"
          class="min-w-[80px]"
          queryParamsHandling="merge"
          themeColor="primary"
        >
          Previous
        </kendo-button>

        <div class="text-lg">
          {{ vm().index + 1 + ' of ' + vm().notesWithFields.length }}
        </div>

        <kendo-button
          [disabled]="vm().disabledNext"
          [queryParams]="vm().nextQueryParam"
          [routerLink]="[]"
          class="min-w-[80px]"
          queryParamsHandling="merge"
          themeColor="primary"
        >
          Next
        </kendo-button>
      </div>
    </footer>
  </div>
</ng-template>

<!--  TODO: Extract related note tempalte-->
<ng-template #relatedNoteSkeleton>
  <div
    *rxLet="vm().visibleNoteWithFields; let note"
    class="flex h-full flex-col"
  >
    <header>
      <div class="flex flex-col">
        <div class="flex">
          <!--        NOTE TYPE        -->
          <div class="px-3 py-4">
            <div class="w-fit rounded p-1.5">
              <kendo-skeleton [width]="75"></kendo-skeleton>
            </div>
          </div>

          <!--        CREATE INFO       -->
          <div class="grow px-3 py-2">
            <div class="flex flex-col gap-1">
              <span class="mb-2 flex gap-1">
                <kendo-skeleton shape="circle" [width]="20"></kendo-skeleton>
                <kendo-skeleton [width]="75"></kendo-skeleton>
              </span>

              <kendo-skeleton [width]="60"></kendo-skeleton>
            </div>
          </div>

          <!--        ACTION ICON       -->
          <div class="p-3">
            <kendo-skeleton [width]="30" [height]="30"></kendo-skeleton>
          </div>
        </div>
        <div class="px-3 pb-6 pt-3">
          <kendo-skeleton [width]="150" [height]="25"></kendo-skeleton>
        </div>
      </div>
    </header>
    <article
      class="border-component-border grow basis-0 overflow-auto border-b border-t"
    >
      <div class="h-full">
        <div class="flex flex-col gap-3">
          <div class="p-3">
            <div class="mb-2 text-[10px] uppercase">
              <kendo-skeleton [width]="80"></kendo-skeleton>
            </div>
            <div class="flex flex-col gap-2">
              <kendo-skeleton width="70%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="40%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="90%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="20%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="40%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="90%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="20%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="40%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="90%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="20%" [height]="15"></kendo-skeleton>
            </div>
          </div>
        </div>
      </div>
    </article>
    <footer>
      <div class="flex items-center justify-between gap-2 p-3">
        <kendo-skeleton [width]="80" [height]="30"></kendo-skeleton>

        <kendo-skeleton [width]="60" [height]="20"></kendo-skeleton>

        <kendo-skeleton [width]="80" [height]="30"></kendo-skeleton>
      </div>
    </footer>
  </div>
</ng-template>

<ng-template #noNotesMessage>
  <p class="text-placeholder-text flex-1 p-3 font-light opacity-60">
    There are no related notes for this section at this time
  </p>
</ng-template>
