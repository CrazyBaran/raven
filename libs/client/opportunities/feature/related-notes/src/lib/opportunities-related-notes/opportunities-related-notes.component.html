<div class="flex h-full gap-3">
  <div
    *ngIf="vm().fields?.length || vm().isLoading"
    [class.opacity-5]="!visible() && !vm().isLoading"
    class="h-full flex-1 overflow-auto"
  >
    <kendo-tilelayout
      [columns]="12"
      [draggable]="false"
      [gap]="12"
      class="!p-0"
      rowHeight="minmax(300px, 1fr)"
    >
      <ng-container [formGroup]="formGroup">
        <ng-container *ngIf="vm().isLoading; else fields">
          <kendo-tilelayout-item
            *rxFor="let i of 2 | times"
            [colSpan]="12"
            [col]="1"
          >
            <kendo-tilelayout-item-header>
              <kendo-skeleton width="60%"></kendo-skeleton>
            </kendo-tilelayout-item-header>
            <kendo-tilelayout-item-body>
              <div class="flex flex-col gap-2">
                <kendo-skeleton width="60%"></kendo-skeleton>
                <kendo-skeleton width="35%"></kendo-skeleton>
                <kendo-skeleton width="70%"></kendo-skeleton>
                <kendo-skeleton width="35%"></kendo-skeleton>
                <kendo-skeleton width="70%"></kendo-skeleton>
              </div>
            </kendo-tilelayout-item-body>
          </kendo-tilelayout-item>
        </ng-container>
        <ng-template #fields>
          <kendo-tilelayout-item
            *rxFor="
              let field of fields$;
              trackBy: 'id';
              renderCallback: itemsRendered
            "
            [colSpan]="12"
            [col]="1"
            [title]="$any(field).title"
          >
            <kendo-tilelayout-item-body>
              <app-rich-text
                [borderless]="true"
                [formControlName]="field.id"
                [grow]="true"
                [proseSettings]="{ proseMirrorSettings: proseMirrorSettings }"
                class="h-full"
                placeholder="Click to write content here..."
              >
              </app-rich-text>
              <!--          <div-->
              <!--            class="bg-grey-100 flex h-full flex-col gap-3 bg-opacity-50 px-6 py-5"-->
              <!--          >-->

              <!--            <div [innerHTML]="field.value | safeHtml"></div>-->
              <!--          </div>-->
            </kendo-tilelayout-item-body>
          </kendo-tilelayout-item>
        </ng-template>
      </ng-container>
    </kendo-tilelayout>
  </div>

  <kendo-tilelayout
    *ngIf="vm().visibleNoteWithFields || vm().notes?.length || vm().isLoading"
    [columns]="12"
    [draggable]="false"
    [gap]="12"
    class="h-full flex-1 !p-0"
    rowHeight="100%"
  >
    <kendo-tilelayout-item [colSpan]="12">
      <kendo-tilelayout-item-header>
        <kendo-skeleton
          *ngIf="vm().isLoading; else relatedNotesTitle"
          width="30%"
        ></kendo-skeleton>
        <ng-template #relatedNotesTitle>
          <p>Related Notes</p>
        </ng-template>
      </kendo-tilelayout-item-header>
      <kendo-tilelayout-item-body>
        <ng-container
          *ngIf="vm().isLoading"
          [ngTemplateOutlet]="relatedNoteSkeleton"
        />

        <ng-container
          *ngIf="vm().visibleNoteWithFields"
          [ngTemplateOutlet]="relatedNote"
        />

        <ng-container
          *ngIf="!vm().visibleNoteWithFields && vm().notes?.length"
          [ngTemplateOutlet]="relatedNotesTable"
        />
        <!--      NOTE    -->
      </kendo-tilelayout-item-body>
    </kendo-tilelayout-item>
  </kendo-tilelayout>
</div>

<ng-template #relatedNote>
  <div
    *rxLet="vm().visibleNoteWithFields; let note"
    class="flex h-full flex-col"
  >
    <header>
      <div class="flex flex-col">
        <div class="flex">
          <!--        NOTE TYPE        -->
          <div class="px-3 py-4">
            <div
              [ngClass]="{
                'bg-series-a-lighten-50': note.templateName === 'Company call',
                'bg-series-e-lighten-50':
                  note.templateName === 'Notes & Analysis',
                'bg-series-g-lighten-50':
                  note.templateName === 'Market Research'
              }"
              class="bg-series-a-lighten-50 w-fit rounded p-1.5"
            >
              {{ note.templateName }}
            </div>
          </div>

          <!--        CREATE INFO       -->
          <div class="grow px-3 py-2">
            <div class="flex flex-col gap-1">
              <span>
                <i class="fa-solid fa-circle-user mr-1"></i>
                {{ note.createdBy.name || '' }}
              </span>

              <span *ngIf="note.updatedAt" class="text-xs">
                Updated:
                {{ note.updatedAt || '' | date: 'dd/MM/yyyy hh:mm a' }}
              </span>
            </div>
          </div>

          <!--        ACTION ICON       -->
          <div class="p-3">
            <kendo-button
              [queryParams]="{ 'note-details': note.id }"
              [routerLink]="['./']"
              iconClass="fa-solid fa-eye"
              queryParamsHandling="merge"
              themeColor="primary"
            >
            </kendo-button>
          </div>
        </div>
        <div class="px-3 pb-6 pt-3">
          <p class="font-bold">{{ note.name }}</p>
        </div>
      </div>
    </header>
    <article
      class="border-component-border grow basis-0 overflow-auto border-b border-t"
    >
      <div class="h-full">
        <div *rxFor="let field of note.fields" class="flex flex-col gap-3">
          <div class="p-3">
            <div class="mb-2 text-[10px] uppercase">
              {{ field.name }}
            </div>
            <div [innerHTML]="field.value | safeHtml" class="ProseMirror"></div>
          </div>
        </div>
      </div>
    </article>
    <footer>
      <div class="flex items-center justify-between gap-2 p-3">
        <kendo-button
          [disabled]="vm().disabledPrev"
          [queryParams]="vm().prevQueryParam"
          [routerLink]="[]"
          class="min-w-[80px]"
          queryParamsHandling="merge"
          themeColor="primary"
        >
          Previous
        </kendo-button>

        <div class="text-lg">
          {{ vm().index + 1 + ' of ' + vm().notesWithFields.length }}
        </div>

        <kendo-button
          [disabled]="vm().disabledNext"
          [queryParams]="vm().nextQueryParam"
          [routerLink]="[]"
          class="min-w-[80px]"
          queryParamsHandling="merge"
          themeColor="primary"
        >
          Next
        </kendo-button>
      </div>
    </footer>
  </div>
</ng-template>

<ng-template #relatedNotesTable>
  <kendo-grid
    [kendoGridBinding]="vm().notes"
    [sort]="sort"
    class="grid-borderless"
  >
    <kendo-grid-column
      [headerStyle]="{ 'font-weight': '700' }"
      field="name"
      title="Note Title"
    >
      <ng-template kendoGridCellTemplate let-dataItem>
        <kendo-button
          [queryParams]="{ 'note-details': dataItem.id }"
          [routerLink]="['./']"
          fillMode="link"
          queryParamsHandling="merge"
        >
          {{ dataItem?.name }}
        </kendo-button>
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-column
      [headerStyle]="{ 'font-weight': '700' }"
      [sortable]="false"
      field="templateName"
      title="Note Type"
    >
      <ng-template kendoGridCellTemplate let-dataItem>
        <div
          *ngIf="dataItem?.templateName"
          class="text-xxs bg-primary-500 flex h-6 w-fit items-center rounded px-[0.375rem] font-normal"
        >
          {{ dataItem?.templateName }}
        </div>
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-column
      [headerStyle]="{ 'font-weight': '700' }"
      field="updatedAt"
      title="Created"
    >
      <ng-template kendoGridCellTemplate let-dataItem>
        <div class="flex flex-col gap-1">
          <span>
            <i class="fa-solid fa-circle-user mr-1"></i>
            {{ dataItem?.createdBy?.name || '' }}
          </span>

          <span class="text-xs">
            Updated:
            {{ dataItem?.updatedAt || '' | date: 'dd/MM/yyyy hh:mm a' }}
          </span>
        </div>
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-column [width]="50">
      <ng-template kendoGridCellTemplate let-dataItem>
        <div class="flex flex-row gap-1" kendoTooltip>
          <kendo-button
            [queryParams]="{ 'note-details': dataItem.id }"
            [routerLink]="['./']"
            iconClass="fa-solid fa-eye"
            queryParamsHandling="merge"
            themeColor="primary"
          />
        </div>
      </ng-template>
    </kendo-grid-column>
  </kendo-grid>
</ng-template>

<!--  TODO: Extract related note tempalte-->
<ng-template #relatedNoteSkeleton>
  <div
    *rxLet="vm().visibleNoteWithFields; let note"
    class="flex h-full flex-col"
  >
    <header>
      <div class="flex flex-col">
        <div class="flex">
          <!--        NOTE TYPE        -->
          <div class="px-3 py-4">
            <div class="w-fit rounded p-1.5">
              <kendo-skeleton [width]="75"></kendo-skeleton>
            </div>
          </div>

          <!--        CREATE INFO       -->
          <div class="grow px-3 py-2">
            <div class="flex flex-col gap-1">
              <span class="mb-2 flex gap-1">
                <kendo-skeleton shape="circle" [width]="20"></kendo-skeleton>
                <kendo-skeleton [width]="75"></kendo-skeleton>
              </span>

              <kendo-skeleton [width]="60"></kendo-skeleton>
            </div>
          </div>

          <!--        ACTION ICON       -->
          <div class="p-3">
            <kendo-skeleton [width]="30" [height]="30"></kendo-skeleton>
          </div>
        </div>
        <div class="px-3 pb-6 pt-3">
          <kendo-skeleton [width]="150" [height]="25"></kendo-skeleton>
        </div>
      </div>
    </header>
    <article
      class="border-component-border grow basis-0 overflow-auto border-b border-t"
    >
      <div class="h-full">
        <div class="flex flex-col gap-3">
          <div class="p-3">
            <div class="mb-2 text-[10px] uppercase">
              <kendo-skeleton [width]="80"></kendo-skeleton>
            </div>
            <div class="flex flex-col gap-2">
              <kendo-skeleton width="70%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="40%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="90%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="20%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="40%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="90%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="20%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="40%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="90%" [height]="15"></kendo-skeleton>
              <kendo-skeleton width="20%" [height]="15"></kendo-skeleton>
            </div>
          </div>
        </div>
      </div>
    </article>
    <footer>
      <div class="flex items-center justify-between gap-2 p-3">
        <kendo-skeleton [width]="80" [height]="30"></kendo-skeleton>

        <kendo-skeleton [width]="60" [height]="20"></kendo-skeleton>

        <kendo-skeleton [width]="80" [height]="30"></kendo-skeleton>
      </div>
    </footer>
  </div>
</ng-template>
