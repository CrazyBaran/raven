<kendo-grid
  #grid
  (scrollBottom)="onLoadMore()"
  (filterChange)="filterChange($event)"
  [data]="gridData"
  [expandedDetailKeys]="collapsedRows()"
  [filter]="filters!"
  [loading]="isLoading"
  [rowClass]="rowCallback"
  [sort]="sort"
  [sortable]="true"
  class="organisation-table h-full"
  filterable="menu"
  kendoGridExpandDetailsBy="id"
  scrollable="scrollable"
  uiKendoUrlSorting
>
  @for (columnTemplate of additionalFields; track columnTemplate.name) {
    <kendo-grid-column
      [field]="columnTemplate.field"
      [title]="columnTemplate.name"
      headerClass="!font-bold"
      [width]="140"
      [filterable]="!!columnTemplate.filter"
      [sortable]="columnTemplate.sortable"
    >
      <ng-template kendoGridCellTemplate let-organisation>
        <div class="text-xs">
          <app-render-template
            [component]="columnTemplate | dynamicColumn: organisation"
          />
        </div>
      </ng-template>

      @if (columnTemplate.filter) {
        <ng-template
          kendoGridFilterMenuTemplate
          let-filter
          let-column="column"
          let-filterService="filterService"
        >
          @switch (columnTemplate.filter) {
            @case ('date') {
              <app-date-range-filter
                [field]="column.field"
                [filter]="filter"
                [filterService]="filterService"
              />
            }
            @case ('string') {
              <app-multicheck-filter
                [sourceFn]="columnTemplate | sourceFn"
                [field]="column.field"
                [filterService]="filterService"
                [currentFilter]="filter"
                [isPrimitive]="true"
              />
            }
            @case ('number') {
              <app-number-range-filter
                [field]="column.field"
                [filter]="filter"
                [filterService]="filterService"
              />
            }
          }
        </ng-template>
      }
    </kendo-grid-column>
  }

  <kendo-grid-column [width]="60" title="">
    <ng-template kendoGridCellTemplate let-organisation>
      @if (organisation.opportunities.length > 0) {
        <kendo-button
          (click)="toggleRow(organisation.id)"
          [iconClass]="
            'fa-solid fa-caret-' +
            (isRowCollapsed(organisation.id) ? 'up' : 'down')
          "
          fillMode="link"
        />
      }
    </ng-template>
  </kendo-grid-column>

  <ng-template kendoGridDetailTemplate let-organisation>
    <app-opportunities-table
      [rows]="organisation.opportunities"
      [style.width]="tableWidth"
    />
  </ng-template>
</kendo-grid>
