<kendo-grid
  #grid
  (filterChange)="filterChange($event)"
  (scrollBottom)="onLoadMore()"
  [data]="gridData"
  [expandedDetailKeys]="collapsedRows()"
  [filter]="filters!"
  [loading]="isLoading"
  [rowClass]="rowCallback"
  [sort]="sort"
  [sortable]="true"
  [trackBy]="trackByFn"
  class="organisation-table h-full"
  filterable="menu"
  kendoGridExpandDetailsBy="id"
  scrollable="scrollable"
  uiKendoUrlSorting
>
  @for (columnTemplate of additionalFields; track columnTemplate.name) {
    <kendo-grid-column
      [field]="columnTemplate.field"
      [title]="columnTemplate.name"
      headerClass="!font-bold"
      [width]="columnTemplate.width ?? 160"
      [filterable]="!!columnTemplate.filter"
      [sortable]="columnTemplate.sortable"
    >
      <ng-template kendoGridCellTemplate let-organisation>
        <div class="text-xs">
          <app-render-template
            [component]="columnTemplate | dynamicColumn: organisation"
          />
        </div>
      </ng-template>

      @if (columnTemplate.filter) {
        <ng-template
          kendoGridFilterMenuTemplate
          let-filter
          let-column="column"
          let-filterService="filterService"
        >
          @switch (columnTemplate.filter) {
            @case ('date') {
              <app-date-range-filter
                [field]="column.field"
                [filter]="filter"
                [filterService]="filterService"
              />
            }
            @case ('string') {
              <app-multicheck-filter
                [sourceFn]="columnTemplate | sourceFn"
                [field]="column.field"
                [filterService]="filterService"
                [currentFilter]="filter"
                [isPrimitive]="true"
              />
            }
            @case ('number') {
              <app-number-range-filter
                [field]="column.field"
                [filter]="filter"
                [filterService]="filterService"
              />
            }
          }
        </ng-template>
      }
    </kendo-grid-column>
  }

  <kendo-grid-column [width]="190" title="">
    <ng-template kendoGridCellTemplate let-organisation>
      <div class="flex justify-end gap-2">
        @if (!organisation.status.name) {
          <kendo-button
            iconClass="fa-solid fa-plus"
            [routerLink]="['./']"
            [queryParams]="getOutreachQueryParam(organisation)"
            [skipLocationChange]="true"
            queryParamsHandling="merge"
            >Outreach</kendo-button
          >
        }
        <app-dropdownbutton-navigation
          [model]="getActionsModel(organisation)"
        />
        <kendo-button
          (click)="toggleRow(organisation.id)"
          [class.invisible]="organisation.opportunities.length === 0"
          [iconClass]="
            'fa-solid fa-caret-' +
            (isRowCollapsed(organisation.id) ? 'up' : 'down')
          "
          fillMode="link"
        />
      </div>
    </ng-template>
  </kendo-grid-column>

  <ng-template kendoGridDetailTemplate let-organisation>
    <app-opportunities-table
      [rows]="organisation.opportunities"
      [style.width]="tableWidth"
    />
  </ng-template>
</kendo-grid>
