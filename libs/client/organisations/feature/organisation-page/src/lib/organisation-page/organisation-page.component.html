<app-page-template>
  <div class="flex items-center gap-2" page-header-title>
    <kendo-button
      [routerLink]="['/companies']"
      fillMode="flat"
      iconClass="fa-sharp fa-regular fa-cart-shopping"
      themeColor="primary"
      >All Companies</kendo-button
    >

    <ng-container *ngIf="vm().currentOrganisation?.name">
      <i
        [@fadeIn]
        class="fa-sharp fa-solid fa-chevron-right text-grey-800 text-xs text-opacity-60"
      ></i>
      <kendo-button
        [@fadeIn]
        [disabled]="true"
        fillMode="flat"
        themeColor="primary"
        >{{ vm().currentOrganisation?.name }}</kendo-button
      >
    </ng-container>
  </div>

  <div class="flex gap-1" page-header-actions></div>

  <div
    class="organisation-details | bg-base-background flex h-full flex-col"
    page-content
  >
    <!--    TILES       -->
    <kendo-tilelayout
      [columns]="12"
      [draggable]="false"
      [gap]="24"
      class="h-full !p-0"
    >
      <!--  DETAILS   -->
      <kendo-tilelayout-item [colSpan]="6" [col]="1" class="h-full w-full">
        <kendo-tilelayout-item-header>
          <div class="flex items-center justify-between gap-2">
            <h5 class="k-card-title">Company details</h5>
            <kendo-button
              [disabled]="true || vm().isLoading"
              [queryParams]="{
                'organisation-edit': vm().currentOrganisationId
              }"
              [routerLink]="['./']"
              iconClass="fa-sharp fa-solid fa-pen"
              queryParamsHandling="merge"
              size="small"
              >Edit</kendo-button
            >
          </div>
        </kendo-tilelayout-item-header>
        <kendo-tilelayout-item-body>
          <div class="bg-grey-100 h-full">
            <div
              class="bg-grey-100 grid grid-cols-2 gap-3 bg-opacity-50 px-6 py-5"
            >
              <ng-template #details>
                <div
                  *rxFor="let detail of vm().details; trackBy: 'label'"
                  [@fadeIn]
                  class="px-2 py-3"
                >
                  <h1 class="text-lg">{{ detail.label }}</h1>
                  <p class="!m-0 text-sm">{{ detail.subLabel }}</p>
                </div>
              </ng-template>
              <ng-container *ngIf="vm().isLoading; else details">
                <div *ngFor="let i of 4 | times" class="px-2 py-3">
                  <kendo-skeleton class="mb-1" height="20" width="80%" />
                  <kendo-skeleton height="10" width="75%" />
                </div>
              </ng-container>
            </div>
          </div>
        </kendo-tilelayout-item-body>
      </kendo-tilelayout-item>

      <!--  Opportunities   -->
      <kendo-tilelayout-item [colSpan]="6" [col]="7" class="h-full w-full">
        <kendo-tilelayout-item-header>
          <div class="flex items-center justify-between gap-2">
            <h5 class="k-card-title">Pipeline</h5>
            <!-- <kendo-button
              [queryParams]="{
                'opportunity-create': vm().currentOrganisationId
              }"
              [routerLink]="['./']"
              iconClass="fa-sharp fa-solid fa-pen"
              size="small"
              >Add new</kendo-button
            > -->
          </div>
        </kendo-tilelayout-item-header>
        <kendo-tilelayout-item-body>
          <kendo-grid
            [kendoGridBinding]="vm().opportunities"
            [loading]="vm().isLoading"
            [sort]="sort"
            [sortable]="true"
            class="grid-borderless h-full"
          >
            <ng-template kendoGridLoadingTemplate>
              <ui-loader [disableInfo]="true" class="bg-white bg-opacity-60" />
            </ng-template>
            <kendo-grid-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Funding Round"
            >
              <ng-template kendoGridCellTemplate let-dataItem>
                <p>{{ dataItem.tag?.name ?? 'No Opportunity' }}</p>
              </ng-template>
            </kendo-grid-column>

            <kendo-grid-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Deal Lead"
            >
              <ng-template kendoGridCellTemplate let-dataItem>
                <ui-tag
                  *rxFor="let name of dataItem.team | dealLeads"
                  [label]="name"
                  uiUserTag
                />
              </ng-template>
            </kendo-grid-column>

            <kendo-grid-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Deal Team"
            >
              <ng-template kendoGridCellTemplate let-dataItem>
                <p>{{ (dataItem.team | dealTeam)?.[0] ?? '' }}</p>
              </ng-template>
            </kendo-grid-column>

            <kendo-grid-column
              [headerStyle]="{ 'font-weight': '700' }"
              field="createdAt"
              title="Created"
            >
              <ng-template kendoGridCellTemplate let-dataItem>
                <div class="flex flex-col gap-1">
                  <p>
                    {{ dataItem?.createdAt || '' | date: 'dd/MM/yyyy hh:mm a' }}
                  </p>
                </div>
              </ng-template>
            </kendo-grid-column>

            <kendo-grid-column [width]="70">
              <ng-template kendoGridCellTemplate let-dataItem>
                <div class="flex flex-row gap-1">
                  <kendo-button
                    [routerLink]="['opportunities', dataItem.id]"
                    iconClass="fa-solid fa-eye"
                    themeColor="primary"
                  />
                </div>
              </ng-template>
            </kendo-grid-column>
          </kendo-grid>
        </kendo-tilelayout-item-body>
      </kendo-tilelayout-item>

      <!--  Files   -->
      <kendo-tilelayout-item [colSpan]="12" [col]="1" class="h-full w-full">
        <kendo-tilelayout-item-header>
          <div class="flex items-center justify-between gap-2">
            <h5 class="k-card-title">Company Files</h5>
            <!--            <kendo-button-->
            <!--                    (click)="openNoteShelf()"-->
            <!--                    iconClass="fa-sharp fa-solid fa-pen"-->
            <!--                    size="small"-->
            <!--            >Add New</kendo-button-->
            <!--            >-->
          </div>
        </kendo-tilelayout-item-header>
        <kendo-tilelayout-item-body>
          <kendo-treelist
            [data]="source()"
            [fetchChildren]="fetchChildren"
            [hasChildren]="hasChildren"
            [loading]="vm().isLoading"
            [rowClass]="rowCallback"
            [trackBy]="trackBy"
            class="grid-borderless flex-1 overflow-hidden"
            kendoTreeListExpandable
            scrollable="scrollable"
          >
            <kendo-treelist-column
              [expandable]="true"
              [headerStyle]="{ 'font-weight': '700' }"
              title="Folder/File Name"
            >
              <ng-template kendoTreeListCellTemplate let-dataItem>
                <span
                  [ngClass]="{
                    'font-bold': dataItem.type === 'folder'
                  }"
                >
                  <i
                    [ngClass]="{
                      'fa-file': dataItem.type === 'file',
                      'fa-folder': dataItem.type === 'folder'
                    }"
                    class="fa-regular"
                  ></i>
                  <span class="ml-2">
                    {{ dataItem.name }}
                  </span>
                </span>
              </ng-template>
            </kendo-treelist-column>

            <kendo-treelist-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Tags"
            >
              <ng-template kendoTreeListCellTemplate let-dataItem>
                @if(dataItem.type === 'file'){
                <div class="text-button flex flex-wrap gap-2 overflow-hidden">
                  <ui-tag
                    class="text-buttons-button-text"
                    *ngFor="let tag of getTagsSource(dataItem) | async"
                    [label]="tag.name"
                    [wrap]="false"
                    size="medium"
                    icon="fa-regular fa-tag"
                  />
                </div>
                }
              </ng-template>
            </kendo-treelist-column>

            <kendo-treelist-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Added by"
            >
              <ng-template kendoTreeListCellTemplate let-dataItem>
                @if(dataItem.type === 'file'){
                <ui-tag uiUserTag [label]="dataItem.createdBy" size="medium" />
                }
              </ng-template>
            </kendo-treelist-column>

            <kendo-treelist-column [width]="120" title="">
              <ng-template kendoTreeListCellTemplate let-dataItem>
                @if(dataItem.type === 'file'){
                <div class="flex gap-1">
                  <kendo-button
                    themeColor="primary"
                    iconClass="fa-solid fa-arrow-up-right-from-square"
                    (click)="openFileWebUrl(dataItem)"
                  />
                  <!--                  <kendo-button-->
                  <!--                    class="mr-10"-->
                  <!--                    iconClass="fa-regular fa-tag"-->
                  <!--                    (click)="openFileManage(dataItem)"-->
                  <!--                  />-->
                </div>
                }
              </ng-template>
            </kendo-treelist-column>
          </kendo-treelist>
        </kendo-tilelayout-item-body>
      </kendo-tilelayout-item>

      <!--  Notes   -->
      <kendo-tilelayout-item [colSpan]="12" [col]="1" class="h-full w-full">
        <kendo-tilelayout-item-header>
          <div class="flex items-center justify-between gap-2">
            <h5 class="k-card-title">Related Notes</h5>
            <kendo-button
              (click)="openNoteShelf()"
              iconClass="fa-sharp fa-solid fa-pen"
              size="small"
              >Add New</kendo-button
            >
          </div>
        </kendo-tilelayout-item-header>
        <kendo-tilelayout-item-body>
          <app-notes-table-container />
        </kendo-tilelayout-item-body>
      </kendo-tilelayout-item>
    </kendo-tilelayout>
  </div>
</app-page-template>

<ng-template #loader>
  <ui-loader />
</ng-template>
