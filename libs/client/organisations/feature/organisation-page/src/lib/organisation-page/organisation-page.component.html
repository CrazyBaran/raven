<app-page-template>
  <div class="flex items-center gap-2" page-header-title>
    <kendo-button
      [routerLink]="['/companies']"
      fillMode="flat"
      iconClass="fa-sharp fa-regular fa-cart-shopping"
      themeColor="primary"
      >All Companies</kendo-button
    >

    @if (vm().currentOrganisation?.name) {
      <i
        [@fadeIn]
        class="fa-sharp fa-solid fa-chevron-right text-grey-800 text-xs text-opacity-60"
      ></i>
      <kendo-button
        [@fadeIn]
        [disabled]="true"
        fillMode="flat"
        themeColor="primary"
        >{{ vm().currentOrganisation?.name }}</kendo-button
      >
    }
  </div>

  <div class="flex gap-2" page-header-actions>
    @if (vm().showStatus) {
      <div class="flex items-center gap-3">
        <i
          [style.color]="vm().status.color"
          class="fa-solid fa-circle text-xs"
        ></i>
        <p [isEllipsisActive]="true" class="flex-1 text-black">
          {{ vm().status.name | titlecase }}
        </p>
      </div>
    }

    @if (vm().showOutreachButton) {
      <kendo-button
        [queryParams]="vm().outreachQueryParams"
        queryParamsHandling="merge"
        [skipLocationChange]="true"
        [routerLink]="['./']"
        themeColor="primary"
        >Add To Outreach</kendo-button
      >
    }

    @if (vm().showPassButton) {
      <app-dropdownbutton-navigation [model]="dropdownButtonActions" />
    }
  </div>

  <div
    class="organisation-details | bg-base-background flex h-full flex-col overflow-auto"
    page-content
  >
    <div class="organisation-page-grid | grid h-full gap-6">
      <!--      rowHeight="minmax(400px,1fr)"-->
      <ui-tilelayout-item id="organisation-details">
        <div class="flex items-center justify-between gap-2" header>
          <h5 class="k-card-title">Company details</h5>
          <kendo-button
            [disabled]="true || vm().isLoading"
            [queryParams]="{
              'organisation-edit': vm().currentOrganisationId
            }"
            [routerLink]="['./']"
            iconClass="fa-sharp fa-solid fa-pen"
            queryParamsHandling="merge"
            size="small"
            >Edit</kendo-button
          >
        </div>
        <div body class="bg-grey-100 h-full overflow-auto">
          <div
            class="bg-grey-100 grid grid-cols-2 gap-3 bg-opacity-50 px-6 py-5"
          >
            @if (vm().isLoading) {
              @for (i of 4 | times; track i) {
                <div class="px-2 py-3">
                  <kendo-skeleton class="mb-1" height="20" width="80%" />
                  <kendo-skeleton height="10" width="75%" />
                </div>
              }
            } @else {
              @for (detail of vm().details; track detail.label) {
                <div [@fadeIn] class="px-2 py-3">
                  <h1 class="text-lg">{{ detail.label }}</h1>
                  <p class="!m-0 text-sm">{{ detail.subLabel }}</p>
                </div>
              }
            }
          </div>
        </div>
      </ui-tilelayout-item>

      <!--  Opportunities   -->
      <!--      class="self-start"-->
      <ui-tilelayout-item id="organisation-opportunities">
        <div class="flex items-center justify-between gap-2" header>
          <h5 class="k-card-title">Opportunities</h5>
          <kendo-button
            [queryParams]="{
              'opportunity-create': vm().currentOrganisationId
            }"
            [routerLink]="['./']"
            iconClass="fa-sharp fa-solid fa-pen"
            size="small"
            >Add new</kendo-button
          >
        </div>
        <!--            [skipLocationChange]="true"-->

        @if (vm().opportunities.length || vm().isLoading) {
          <kendo-grid
            body
            [kendoGridBinding]="vm().opportunities"
            [loading]="vm().isLoading"
            [sort]="sort"
            [sortable]="true"
            class="grid-borderless max-h-full"
          >
            <ng-template kendoGridLoadingTemplate>
              <ui-loader [disableInfo]="true" class="bg-white bg-opacity-60" />
            </ng-template>
            <kendo-grid-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Funding Round"
            >
              <ng-template kendoGridCellTemplate let-dataItem>
                <p>{{ dataItem.tag?.name ?? 'No Opportunity' }}</p>
                <p class="text-xs">
                  Updated: {{ dataItem?.createdAt || '' | date: 'dd/MM/yyyy' }}
                </p>
              </ng-template>
            </kendo-grid-column>

            <kendo-grid-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Status"
            >
              <ng-template kendoGridCellTemplate let-dataItem>
                <div class="flex items-center gap-3">
                  <i
                    [style.color]="dataItem.status?.color"
                    class="fa-solid fa-circle text-xs"
                  ></i>
                  <p [isEllipsisActive]="true" class="flex-1 text-black">
                    {{ dataItem.status?.name ?? '' }}
                  </p>
                </div>
              </ng-template>
            </kendo-grid-column>

            <kendo-grid-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Deal Lead"
            >
              <ng-template kendoGridCellTemplate let-dataItem>
                @for (name of dataItem.team | dealLeads; track name) {
                  <ui-tag [label]="name" uiUserTag />
                }
              </ng-template>
            </kendo-grid-column>

            <kendo-grid-column [width]="70">
              <ng-template kendoGridCellTemplate let-dataItem>
                <div class="flex flex-row gap-1">
                  <kendo-button
                    [routerLink]="['opportunities', dataItem.id]"
                    iconClass="fa-solid fa-eye"
                    themeColor="primary"
                  />
                </div>
              </ng-template>
            </kendo-grid-column>
          </kendo-grid>
        } @else {
          <div class="flex items-center gap-3 px-16 py-9">
            <i class="fa-regular fa-circle-info"></i>
            <p class="text-subtle-text !m-0 text-sm italic">
              There are no existing pipeline items or opportunities for this
              company. Select Add to Outreach to create a new pipeline item.
            </p>
          </div>
        }
      </ui-tilelayout-item>

      <!--  Files   -->
      <ui-tilelayout-item id="organisation-files">
        <div class="flex items-center justify-between gap-2" header>
          <h5 class="k-card-title">Company Files</h5>

          @if (vm().hasFileFolder) {
            <app-picker
              (selectFiles)="onPickerChange($event)"
              [web]="sharepointWeb!"
              [list]="sharepointList!"
              [folder]="vm().sharepointFolder!"
              [url]="sharepointUrl!"
              name="Manage Files"
            />
          }
        </div>

        <ng-container body>
          @if (vm().isLoading) {
          } @else if (vm().hasFileFolder) {
            <kendo-treelist
              [data]="source()"
              [fetchChildren]="fetchChildren"
              [hasChildren]="hasChildren"
              [loading]="vm().isLoading"
              [rowClass]="rowCallback"
              [trackBy]="trackBy"
              class="grid-borderless h-full overflow-hidden"
              kendoTreeListExpandable
              scrollable="scrollable"
            >
              <kendo-treelist-column
                [expandable]="true"
                [headerStyle]="{ 'font-weight': '700' }"
                title="Folder/File Name"
              >
                <ng-template kendoTreeListCellTemplate let-dataItem>
                  <span
                    [ngClass]="{
                      'font-bold': dataItem.type === 'folder'
                    }"
                  >
                    <i
                      [ngClass]="{
                        'fa-file': dataItem.type === 'file',
                        'fa-folder': dataItem.type === 'folder'
                      }"
                      class="fa-regular"
                    ></i>
                    <span class="ml-2">
                      {{ dataItem.name }}
                    </span>
                  </span>
                </ng-template>
              </kendo-treelist-column>

              <kendo-treelist-column
                [headerStyle]="{ 'font-weight': '700' }"
                title="Tags"
              >
                <ng-template kendoTreeListCellTemplate let-dataItem>
                  @if (dataItem.type === 'file') {
                    <div
                      class="text-button flex flex-wrap gap-2 overflow-hidden"
                    >
                      @for (
                        tag of getTagsSource(dataItem) | async;
                        track tag.id
                      ) {
                        <ui-tag
                          class="text-buttons-button-text"
                          [label]="tag.name"
                          [wrap]="false"
                          size="medium"
                          icon="fa-regular fa-tag"
                        />
                      }
                    </div>
                  }
                </ng-template>
              </kendo-treelist-column>

              <kendo-treelist-column
                [headerStyle]="{ 'font-weight': '700' }"
                title="Added by"
              >
                <ng-template kendoTreeListCellTemplate let-dataItem>
                  @if (dataItem.type === 'file') {
                    <ui-tag
                      uiUserTag
                      [label]="dataItem.createdBy"
                      size="medium"
                    />
                  }
                </ng-template>
              </kendo-treelist-column>

              <kendo-treelist-column [width]="120" title="">
                <ng-template kendoTreeListCellTemplate let-dataItem>
                  @if (dataItem.type === 'file') {
                    <div class="flex gap-1">
                      <kendo-button
                        themeColor="primary"
                        iconClass="fa-solid fa-arrow-up-right-from-square"
                        (click)="openFileWebUrl(dataItem)"
                      />
                    </div>
                  }
                </ng-template>
              </kendo-treelist-column>
            </kendo-treelist>
          } @else {
            <div class="flex h-full flex-col items-center justify-center">
              <p class="text-subtle-text mb-1 text-sm italic">
                There is no existing folder in SharePoint for this company. To
                create one please click the button below.
              </p>
              <kendo-button
                (click)="createOrganisationFolder()"
                [disabled]="vm().isCreatingSharepointFolder"
              >
                @if (vm().isCreatingSharepointFolder) {
                  <kendo-loader class="!text-secondary-100 mr-1" size="small" />
                }
                Create Organisation Folder</kendo-button
              >
            </div>
          }
        </ng-container>
      </ui-tilelayout-item>

      <!--  Notes   -->
      <ui-tilelayout-item id="organisation-notes">
        <div class="flex items-center justify-between gap-2" header>
          <h5 class="k-card-title">Related Notes</h5>
          <kendo-button
            (click)="openNoteShelf()"
            iconClass="fa-sharp fa-solid fa-pen"
            size="small"
            >Add New</kendo-button
          >
        </div>
        <app-notes-table-container body />
      </ui-tilelayout-item>
    </div>
  </div>
</app-page-template>
