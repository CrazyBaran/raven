<kendo-panelbar class="white-tilelayout">
  <kendo-panelbar-item [expanded]="false" title="Related Notes">
    <ng-template kendoPanelBarItemTitle>
      <div class="k-card-title !m-0 flex w-full items-center !text-black">
        Company Files

        @if (vm().hasFileFolder) {
          <app-picker
            class="ml-auto mr-2"
            (selectFiles)="onPickerChange($event)"
            [web]="sharepointWeb!"
            [list]="sharepointList!"
            [folder]="vm().sharepointFolder!"
            [url]="sharepointUrl!"
            theme="base"
            name="Manage Files"
          />
        }
      </div>
    </ng-template>
    <ng-template kendoPanelBarContent>
      <div class="h-[363px]">
        @if (vm().isLoading) {
        } @else if (vm().hasFileFolder) {
          <kendo-treelist
            [data]="source()"
            [fetchChildren]="fetchChildren"
            [hasChildren]="hasChildren"
            [loading]="!!vm().isLoading"
            [rowClass]="rowCallback"
            [trackBy]="trackBy"
            class="grid-borderless h-full overflow-hidden"
            kendoTreeListExpandable
            scrollable="scrollable"
          >
            <kendo-treelist-column
              [expandable]="true"
              [headerStyle]="{ 'font-weight': '700' }"
              title="Folder/File Name"
            >
              <ng-template kendoTreeListCellTemplate let-dataItem>
                <span
                  [ngClass]="{
                    'font-bold': dataItem.type === 'folder'
                  }"
                >
                  <i
                    [ngClass]="{
                      'fa-file': dataItem.type === 'file',
                      'fa-folder': dataItem.type === 'folder'
                    }"
                    class="fa-regular"
                  ></i>
                  <span class="ml-2">
                    {{ dataItem.name }}
                  </span>
                </span>
              </ng-template>
            </kendo-treelist-column>

            <kendo-treelist-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Tags"
            >
              <ng-template kendoTreeListCellTemplate let-dataItem>
                @if (dataItem.type === 'file') {
                  <div class="text-button flex flex-wrap gap-2 overflow-hidden">
                    @for (tag of getTagsSource(dataItem) | push; track tag.id) {
                      <ui-tag
                        class="text-buttons-button-text"
                        [label]="tag.name"
                        [wrap]="false"
                        size="medium"
                        icon="fa-regular fa-tag"
                      />
                    }
                  </div>
                }
              </ng-template>
            </kendo-treelist-column>

            <kendo-treelist-column
              [headerStyle]="{ 'font-weight': '700' }"
              title="Added by"
            >
              <ng-template kendoTreeListCellTemplate let-dataItem>
                @if (dataItem.type === 'file') {
                  <ui-tag
                    uiUserTag
                    [label]="dataItem.createdBy"
                    size="medium"
                  />
                }
              </ng-template>
            </kendo-treelist-column>

            <kendo-treelist-column [width]="120" title="">
              <ng-template kendoTreeListCellTemplate let-dataItem>
                @if (dataItem.type === 'file') {
                  <div class="flex gap-1">
                    <kendo-button
                      themeColor="primary"
                      iconClass="fa-solid fa-arrow-up-right-from-square"
                      (click)="openFileWebUrl(dataItem)"
                    />
                  </div>
                }
              </ng-template>
            </kendo-treelist-column>
          </kendo-treelist>
        } @else {
          <div class="flex h-full flex-col items-center justify-center">
            <p class="text-subtle-text mb-1 text-sm italic">
              There is no existing folder in SharePoint for this company. To
              create one please click the button below.
            </p>
            <kendo-button
              (click)="createOrganisationFolder()"
              [disabled]="vm().isCreatingSharepointFolder"
            >
              @if (vm().isCreatingSharepointFolder) {
                <kendo-loader class="!text-secondary-100 mr-1" size="small" />
              }
              Create Organisation Folder
            </kendo-button>
          </div>
        }
      </div>
    </ng-template>
  </kendo-panelbar-item>
</kendo-panelbar>
